<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>boxXcel — Parent Progress</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>
<body>
<script src="/auth/guard.js"></script>

<div class="shell">
  <div class="topbar" data-topbar></div>

  <div class="container">
    <div data-nav></div>

    <!-- Header card -->
    <div class="card" style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
      <div>
        <h2 style="margin:0;">Parent – Progress</h2>
        <div class="small" id="statusText">Loading…</div>
      </div>

      <div style="display:flex; align-items:center; gap:10px;">
        <button class="btn" id="prevWeekBtn" type="button">◀ Previous</button>
        <div class="small" id="weekLabel" style="white-space:nowrap;"></div>
        <button class="btn" id="nextWeekBtn" type="button">Next ▶</button>

        <!-- optional manual refresh -->
        <button class="btn secondary" id="refreshBtn" type="button" title="Refresh now">⟳</button>
      </div>
    </div>

    <!-- Summary tiles -->
    <div style="display:grid; grid-template-columns: repeat(3, minmax(0, 1fr)); gap:16px; margin-top:16px;">
      <div class="card">
        <div class="small">Days completed</div>
        <div style="font-size:42px; font-weight:800; line-height:1;" id="daysCompleted">0/7</div>
      </div>

      <div class="card">
        <div class="small">Cards completed</div>
        <div style="font-size:42px; font-weight:800; line-height:1;" id="cardsCompleted">0/0</div>
      </div>

      <div class="card">
        <div class="small">Completion</div>
        <div style="font-size:42px; font-weight:800; line-height:1;" id="completionPct">0%</div>
      </div>
    </div>

    <!-- Detail card -->
    <div class="card" style="margin-top:16px;">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:16px;">
        <div>
          <div class="small" style="margin-bottom:6px;"><strong>Selected boxer</strong></div>
          <select id="boxerSelect" class="input" style="min-width:280px;"></select>
        </div>
        <div class="small" id="apiNote" style="text-align:right;"></div>
      </div>

      <div style="margin-top:14px;" id="detailArea" class="small">
        No progress loaded yet.
      </div>
    </div>

    <div class="footer">
      boxXcel — Training support application. Training and information only.
    </div>
  </div>
</div>

<script src="/assets/app.js"></script>
<script>
  renderTopbar("boxXcel — Parent Progress");
  renderNav();

  // ✅ IMPORTANT: Correct API base (5l4, not 514)
  const API_BASE = "https://0v4tvwe5l4.execute-api.eu-west-2.amazonaws.com/prod";

  // Auto-refresh settings
  const AUTO_REFRESH_MS = 10_000; // 10 seconds
  let refreshTimer = null;
  let isLoading = false;

  // ---------- date helpers ----------
  function isoDate(d){
    const x = new Date(d);
    const off = x.getTimezoneOffset();
    const local = new Date(x.getTime() - off * 60000);
    return local.toISOString().slice(0,10);
  }
  function startOfWeekMonday(d){
    const x = new Date(d);
    const day = (x.getDay() + 6) % 7; // Mon=0 ... Sun=6
    x.setDate(x.getDate() - day);
    x.setHours(0,0,0,0);
    return x;
  }

  let weekStart = startOfWeekMonday(new Date());
  let selectedBoxerId = "";

  function setWeekLabel(){
    const start = new Date(weekStart);
    const end = new Date(weekStart);
    end.setDate(end.getDate() + 6);
    document.getElementById("weekLabel").textContent =
      `Week: ${isoDate(start)} → ${isoDate(end)}`;
  }

  async function fetchParentProgress(){
    // ✅ Use id_token (matches your other API calls and common Cognito authorizer setups)
    const token = localStorage.getItem("id_token");
    if (!token) {
      document.getElementById("statusText").textContent = "No id token found — please login again.";
      return null;
    }

    const qs = new URLSearchParams();
    qs.set("week_start", isoDate(weekStart));
    if (selectedBoxerId) qs.set("boxer_id", selectedBoxerId);

    const url = `${API_BASE}/api/parent/progress?${qs.toString()}`;

    const res = await fetch(url, {
      method: "GET",
      headers: { "Authorization": `Bearer ${token}` },
      cache: "no-store"
    });

    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch { /* ignore */ }

    if (!res.ok) {
      const msg = (data && data.message) ? data.message : text || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  function fillBoxerDropdown(boxers){
    const sel = document.getElementById("boxerSelect");
    sel.innerHTML = "";

    if (!boxers || !boxers.length) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "No linked boxers found";
      sel.appendChild(opt);
      selectedBoxerId = "";
      return;
    }

    // Keep selected if possible
    const stillExists = selectedBoxerId && boxers.some(b => b.boxer_id === selectedBoxerId);
    if (!stillExists) selectedBoxerId = boxers[0].boxer_id;

    for (const b of boxers) {
      const opt = document.createElement("option");
      opt.value = b.boxer_id;
      opt.textContent = b.display_name || b.boxer_id;
      if (b.boxer_id === selectedBoxerId) opt.selected = true;
      sel.appendChild(opt);
    }

    sel.onchange = () => {
      selectedBoxerId = sel.value;
      load({ force: true });
    };
  }

  function renderDashboard(data){
    document.getElementById("statusText").textContent = "Loaded ✓";

    fillBoxerDropdown(data.boxers || []);

    if (data.selected_boxer_id) selectedBoxerId = data.selected_boxer_id;

    const s = data.summary || {};
    const daysDone = Number(s.days_completed || 0);
    const totalDays = Number(s.total_days || 7);
    const cardsDone = Number(s.cards_completed || 0);
    const totalCards = Number(s.total_cards || 0);
    const pct = Number(s.completion_pct || 0);

    document.getElementById("daysCompleted").textContent = `${daysDone}/${totalDays}`;
    document.getElementById("cardsCompleted").textContent = `${cardsDone}/${totalCards}`;
    document.getElementById("completionPct").textContent = `${pct}%`;

    const detail = data.detail || {};
    const boxerName =
      (data.boxers || []).find(b => b.boxer_id === selectedBoxerId)?.display_name
      || selectedBoxerId
      || "(not selected)";

    document.getElementById("detailArea").innerHTML = `
      <div><strong>Boxer:</strong> ${boxerName}</div>
      <div style="margin-top:8px;"><strong>Week start:</strong> ${data.week_start || ""}</div>
      <div><strong>Week end:</strong> ${data.week_end || ""}</div>
      <div style="margin-top:10px;"><strong>Notes:</strong> ${detail.note || "No extra detail yet."}</div>
    `;

    document.getElementById("apiNote").textContent = "";
  }

  async function load({ force = false } = {}){
    if (isLoading && !force) return;
    isLoading = true;

    setWeekLabel();
    document.getElementById("statusText").textContent = "Loading…";

    try {
      const data = await fetchParentProgress();
      if (!data) return;
      renderDashboard(data);

      const now = new Date();
      document.getElementById("apiNote").textContent = `Auto-refresh: ${AUTO_REFRESH_MS/1000}s • Last: ${now.toLocaleTimeString()}`;
      console.log("Parent progress data:", data);
    } catch (err) {
      console.error(err);
      document.getElementById("statusText").textContent = "Failed to load progress (check console).";
      document.getElementById("apiNote").textContent = String(err.message || err);
    } finally {
      isLoading = false;
    }
  }

  function startAutoRefresh(){
    stopAutoRefresh();
    refreshTimer = setInterval(() => {
      // only refresh while tab is visible
      if (!document.hidden) load();
    }, AUTO_REFRESH_MS);
  }
  function stopAutoRefresh(){
    if (refreshTimer) clearInterval(refreshTimer);
    refreshTimer = null;
  }

  document.getElementById("prevWeekBtn").onclick = () => {
    weekStart.setDate(weekStart.getDate() - 7);
    load({ force: true });
  };
  document.getElementById("nextWeekBtn").onclick = () => {
    weekStart.setDate(weekStart.getDate() + 7);
    load({ force: true });
  };
  document.getElementById("refreshBtn").onclick = () => load({ force: true });

  // Refresh when tab becomes active again (useful on mobile)
  document.addEventListener("visibilitychange", () => {
    if (!document.hidden) load();
  });

  // Start
  load({ force: true });
  startAutoRefresh();
</script>
</body>
</html>
