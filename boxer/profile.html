<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>boxXcel — Profile</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>
<body>

<script src="/auth/guard.js"></script>

<div class="shell">
  <div class="topbar" data-topbar></div>

  <div class="container">
    <div data-nav></div>

    <div class="card">
      <h2 style="margin:0;">Boxer Profile</h2>
      <div class="small" id="statusText">Loading…</div>
      <div class="small">This page saves to the database.</div>
    </div>

    <!-- Boxer ID -->
    <div class="card" style="margin-top:16px;">
      <div class="small"><strong>Your boxer_id</strong></div>
      <div class="small" style="margin-bottom:8px;">Tip: this must match the boxer linked to your login.</div>

      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <input id="boxer_id" class="input" style="min-width:360px;" />
        <button class="btn secondary" id="copyBoxerId" type="button">Copy</button>
      </div>
    </div>

    <!-- Profile form -->
    <div class="card" style="margin-top:16px;">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
        <div>
          <div class="small"><strong>First name</strong></div>
          <input id="first_name" class="input" />
        </div>

        <div>
          <div class="small"><strong>Last name</strong></div>
          <input id="last_name" class="input" />
        </div>

        <div>
          <div class="small"><strong>Date of birth (UK)</strong></div>
          <input id="dob" class="input" placeholder="DD/MM/YYYY" />
          <div class="small" style="opacity:.8;">Example: 24/02/2011</div>
        </div>

        <div>
          <div class="small"><strong>Club</strong></div>
          <input id="club" class="input" />
        </div>

        <div>
          <div class="small"><strong>Stance</strong></div>
          <select id="stance" class="input">
            <option value="">(select)</option>
            <option value="orthodox">Orthodox</option>
            <option value="southpaw">Southpaw</option>
          </select>
        </div>

        <div>
          <div class="small"><strong>Injury notes</strong></div>
          <input id="notes" class="input" placeholder="optional" />
        </div>
      </div>

      <div style="margin-top:16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button class="btn" id="saveBtn" type="button">Save profile to DB</button>
        <span class="small" id="saveMsg"></span>
      </div>

      <div class="small" style="margin-top:10px; opacity:.85;">
        Tip: Open DevTools → Network → Fetch/XHR, then press Save. You will see the POST and the JSON payload.
      </div>
    </div>

    <div class="footer">boxXcel — Training and information only</div>
  </div>
</div>

<script src="/assets/app.js"></script>
<script>
  renderTopbar("boxXcel — Profile");
  renderNav();

  const API_BASE = "https://0v4tvwe5l4.execute-api.eu-west-2.amazonaws.com/prod";
  const PROFILE_URL = API_BASE + "/api/boxer/profile";

  // If you already store boxer_id in local settings, we’ll read it:
  const SETTINGS_KEY = "boxxcel_settings_v1";

  function loadSettings(){
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveSettings(s){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
  }

  function getIdToken(){
    return localStorage.getItem("id_token") || "";
  }

  function ukDateToIso(ukDate) {
    if (!ukDate) return null;
    const parts = ukDate.split("/");
    if (parts.length !== 3) return null;
    const [dd, mm, yyyy] = parts.map(x => (x || "").trim());
    if (!dd || !mm || !yyyy) return null;
    if (yyyy.length !== 4) return null;
    // basic validation
    const d = Number(dd), m = Number(mm), y = Number(yyyy);
    if (!Number.isFinite(d) || !Number.isFinite(m) || !Number.isFinite(y)) return null;
    if (d < 1 || d > 31 || m < 1 || m > 12) return null;

    // pad
    const dd2 = String(d).padStart(2,"0");
    const mm2 = String(m).padStart(2,"0");
    return `${yyyy}-${mm2}-${dd2}`;
  }

  function isoToUk(iso) {
    if (!iso) return "";
    const parts = iso.split("-");
    if (parts.length !== 3) return "";
    const [yyyy, mm, dd] = parts;
    if (!yyyy || !mm || !dd) return "";
    return `${dd}/${mm}/${yyyy}`;
  }

  function setStatus(msg){
    document.getElementById("statusText").textContent = msg;
  }

  async function apiGetProfile(boxerId){
    const token = getIdToken();
    if (!token) throw new Error("Missing id_token (please login again).");

    const url = PROFILE_URL + "?boxer_id=" + encodeURIComponent(boxerId);
    const res = await fetch(url, {
      method: "GET",
      headers: { "Authorization": "Bearer " + token },
      cache: "no-store"
    });

    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch {}

    if (!res.ok) {
      // if profile doesn't exist yet, we don't hard-fail, we just show message
      throw new Error((data && data.error) ? data.error : (data && data.message) ? data.message : text || ("HTTP " + res.status));
    }

    return data;
  }

  async function apiSaveProfile(payload){
    const token = getIdToken();
    if (!token) throw new Error("Missing id_token (please login again).");

    const res = await fetch(PROFILE_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch {}

    if (!res.ok) {
      const msg = (data && (data.error || data.message)) ? (data.error || data.message) : text || ("HTTP " + res.status);
      throw new Error(msg);
    }

    return data;
  }

  function readForm(){
    const boxer_id = (document.getElementById("boxer_id").value || "").trim();
    const dobUk = (document.getElementById("dob").value || "").trim();
    const dobIso = ukDateToIso(dobUk);

    if (!boxer_id) throw new Error("Missing boxer_id");
    if (dobUk && !dobIso) throw new Error("DOB must be in DD/MM/YYYY format");

    return {
      boxer_id,
      first_name: (document.getElementById("first_name").value || "").trim() || null,
      last_name: (document.getElementById("last_name").value || "").trim() || null,
      dob: dobIso, // IMPORTANT: send ISO to API/DB
      club: (document.getElementById("club").value || "").trim() || null,
      stance: (document.getElementById("stance").value || "").trim() || null,
      notes: (document.getElementById("notes").value || "").trim() || null
    };
  }

  function fillFormFromProfile(p){
    if (!p) return;
    document.getElementById("first_name").value = p.first_name || "";
    document.getElementById("last_name").value  = p.last_name || "";
    document.getElementById("dob").value        = isoToUk(p.dob || "");
    document.getElementById("club").value       = p.club || "";
    document.getElementById("stance").value     = p.stance || "";
    document.getElementById("notes").value      = p.notes || "";
  }

  async function boot(){
    // Prefer boxer_id from settings if present
    const settings = loadSettings();
    const existingBoxerId = (settings.boxer_id || settings.boxerId || "").trim();

    if (existingBoxerId) {
      document.getElementById("boxer_id").value = existingBoxerId;
    }

    setStatus("Loaded ✓");

    // If we have a boxer_id, try GET to load existing profile
    if (existingBoxerId) {
      try {
        const data = await apiGetProfile(existingBoxerId);
        if (data && data.profile) {
          fillFormFromProfile(data.profile);
          setStatus("Loaded ✓ (profile found)");
        } else {
          setStatus("Loaded ✓ (no saved profile yet)");
        }
      } catch (e) {
        // Not fatal
        console.warn("GET profile failed:", e);
        setStatus("Loaded ✓ (no saved profile yet, or GET failed — check console)");
      }
    } else {
      setStatus("Loaded ✓ (enter boxer_id then Save)");
    }
  }

  document.getElementById("copyBoxerId").onclick = async () => {
    const v = document.getElementById("boxer_id").value || "";
    try {
      await navigator.clipboard.writeText(v);
      alert("Copied ✅");
    } catch {
      alert("Could not copy (browser blocked). You can copy manually.");
    }
  };

  document.getElementById("saveBtn").onclick = async () => {
    const msg = document.getElementById("saveMsg");
    msg.textContent = "";

    let payload;
    try {
      payload = readForm();
    } catch (e) {
      alert("Save failed: " + (e.message || e));
      return;
    }

    // Store boxer_id in settings so other pages can use it
    const s = loadSettings();
    s.boxer_id = payload.boxer_id;
    saveSettings(s);

    document.getElementById("saveBtn").disabled = true;

    try {
      const data = await apiSaveProfile(payload);
      console.log("Saved:", data);
      msg.textContent = "Saved ✓";
      setTimeout(() => msg.textContent = "", 2000);
      alert("Profile saved successfully ✅");
    } catch (e) {
      console.error(e);
      alert("Save failed: " + (e.message || e));
    } finally {
      document.getElementById("saveBtn").disabled = false;
    }
  };

  boot();
</script>
</body>
</html>
