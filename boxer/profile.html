<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>boxXcel — Boxer Profile</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>
<body>

<script src="/auth/guard.js"></script>

<div class="shell">
  <div class="topbar" data-topbar></div>

  <div class="container">
    <div data-nav></div>

    <div class="card">
      <h2 style="margin:0;">Boxer Profile</h2>
      <div class="small" id="statusText">Loading…</div>
      <div class="small">This page saves to the database.</div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="small"><strong>Your boxer_id</strong></div>
      <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:8px;">
        <input id="boxerId" class="input" style="min-width:340px;" placeholder="paste boxer_id here" />
        <button class="btn secondary" type="button" id="copyBtn">Copy</button>
      </div>
      <div class="small" style="margin-top:8px;">
        Tip: this must match the boxer linked to your login.
      </div>
    </div>

    <div class="card" style="margin-top:16px;">
      <div style="display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap:12px;">
        <div>
          <div class="small"><strong>First name</strong></div>
          <input id="firstName" class="input" />
        </div>

        <div>
          <div class="small"><strong>Last name</strong></div>
          <input id="lastName" class="input" />
        </div>

        <div>
          <div class="small"><strong>Date of birth</strong></div>
          <input id="dob" type="date" class="input" />
        </div>

        <div>
          <div class="small"><strong>Club</strong></div>
          <input id="club" class="input" />
        </div>

        <div>
          <div class="small"><strong>Stance</strong></div>
          <select id="stance" class="input">
            <option value="">(select)</option>
            <option value="orthodox">Orthodox</option>
            <option value="southpaw">Southpaw</option>
          </select>
        </div>

        <div>
          <div class="small"><strong>Injury notes</strong></div>
          <input id="notes" class="input" placeholder="optional" />
        </div>
      </div>

      <div style="margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button class="btn" type="button" id="saveBtn">Save profile to DB</button>
        <span class="small" id="saveResult"></span>
      </div>

      <div class="small" style="margin-top:10px;">
        Tip: Open DevTools → Network → Fetch/XHR, press Save, then click the POST to see Request Payload.
      </div>
    </div>

    <div class="footer">boxXcel — Training and information only</div>
  </div>
</div>

<!-- IMPORTANT: app.js must load BEFORE our inline script -->
<script src="/assets/app.js"></script>

<script>
  // ---------- CONFIG ----------
  const API_BASE = "https://0v4tvwe5l4.execute-api.eu-west-2.amazonaws.com/prod";
  const SETTINGS_KEY = "boxxcel_settings_v1";

  // ---------- NAV (this is why your buttons vanished before if app.js failed) ----------
  renderTopbar("boxXcel — Profile");
  renderNav();

  // ---------- SETTINGS ----------
  function loadSettings(){
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}"); }
    catch { return {}; }
  }

  function saveSettings(s){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
  }

  function setBoxerId(boxer_id){
    const s = loadSettings();
    s.boxer_id = boxer_id;
    saveSettings(s);
  }

  function getBoxerIdFromSettings(){
    const s = loadSettings();
    return (s.boxer_id || s.boxerId || "").trim();
  }

  // ---------- AUTH ----------
  function getAuthToken(){
    // HTTP API JWT authorizer usually expects access_token
    return localStorage.getItem("access_token") || localStorage.getItem("id_token") || "";
  }

  function authHeadersJson(){
    const t = getAuthToken();
    return {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + t
    };
  }

  // ---------- FORM ----------
  function readForm(){
    return {
      first_name: (document.getElementById("firstName").value || "").trim(),
      last_name:  (document.getElementById("lastName").value || "").trim(),
      dob:        (document.getElementById("dob").value || "").trim(),
      club:       (document.getElementById("club").value || "").trim(),
      stance:     (document.getElementById("stance").value || "").trim(),
      notes:      (document.getElementById("notes").value || "").trim()
    };
  }

  function writeForm(p){
    document.getElementById("firstName").value = p?.first_name || "";
    document.getElementById("lastName").value  = p?.last_name || "";
    document.getElementById("dob").value       = p?.dob ? String(p.dob).slice(0,10) : "";
    document.getElementById("club").value      = p?.club || "";
    document.getElementById("stance").value    = p?.stance || "";
    document.getElementById("notes").value     = p?.notes || "";
  }

  // ---------- API ----------
  async function apiGetProfile(boxer_id){
    const url = `${API_BASE}/api/boxer/profile?boxer_id=${encodeURIComponent(boxer_id)}`;
    const res = await fetch(url, { method:"GET", headers: authHeadersJson(), cache:"no-store" });
    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch {}
    if (!res.ok) throw new Error(text || ("HTTP " + res.status));
    return data;
  }

  async function apiSaveProfile(payload){
    const res = await fetch(`${API_BASE}/api/boxer/profile`, {
      method: "POST",
      headers: authHeadersJson(),
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    let data = null;
    try { data = JSON.parse(text); } catch {}

    if (!res.ok){
      throw new Error((data && (data.error || data.message)) ? (data.error || data.message) : text || ("HTTP " + res.status));
    }
    return data;
  }

  // ---------- UI ----------
  document.getElementById("copyBtn").onclick = async () => {
    const v = document.getElementById("boxerId").value || "";
    try { await navigator.clipboard.writeText(v); } catch {}
  };

  document.getElementById("saveBtn").onclick = async () => {
    const saveResult = document.getElementById("saveResult");
    saveResult.textContent = "";

    // ✅ SOURCE OF TRUTH: textbox (not settings)
    const boxer_id = (document.getElementById("boxerId").value || "").trim();
    if (!boxer_id){
      alert("Missing boxer_id. Paste it into the boxer_id box first.");
      return;
    }

    // ✅ persist for other pages
    setBoxerId(boxer_id);

    const payload = { boxer_id, ...readForm() };

    // convert "" -> null so Postgres casts don’t break
    for (const k of Object.keys(payload)){
      if (payload[k] === "") payload[k] = null;
    }

    const btn = document.getElementById("saveBtn");
    btn.disabled = true;

    try {
      const data = await apiSaveProfile(payload);
      console.log("SAVE OK:", data);
      saveResult.textContent = "Saved ✓";
      document.getElementById("statusText").textContent = "Loaded ✓ (saved)";
    } catch (e) {
      console.error(e);
      alert("Save failed: " + (e.message || e));
      saveResult.textContent = "Save failed";
    } finally {
      btn.disabled = false;
      setTimeout(()=> saveResult.textContent = "", 2500);
    }
  };

  async function boot(){
    // Pre-fill boxer_id from settings so it’s not blank
    const fromSettings = getBoxerIdFromSettings();
    if (fromSettings) document.getElementById("boxerId").value = fromSettings;

    document.getElementById("statusText").textContent = "Loaded ✓";

    // If we already have boxer_id, try loading existing profile
    const boxer_id = (document.getElementById("boxerId").value || "").trim();
    if (boxer_id){
      try{
        const data = await apiGetProfile(boxer_id);
        if (data && data.profile) writeForm(data.profile);
      }catch(e){
        console.warn("GET profile failed (ok if none yet):", e);
      }
    }
  }

  boot();
</script>
</body>
</html>
