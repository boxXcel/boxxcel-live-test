<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>boxXcel — Profile</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>
<body>

<script src="/auth/guard.js"></script>

<div class="shell">
  <div class="topbar" data-topbar></div>

  <div class="container">
    <div data-nav></div>

    <div class="card">
      <h2>Boxer Profile</h2>
      <div class="small" id="statusLine">Loading ✓</div>
      <div class="small">This page saves to the database.</div>
    </div>

    <div class="card">
      <strong>Your boxer_id</strong>
      <div class="small">Tip: this must match the boxer linked to your login.</div>

      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <input id="boxerId" type="text"
          style="flex:1; min-width:260px; padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
        <button class="btn secondary" id="copyBoxerId" type="button">Copy</button>
      </div>

      <div class="small" style="margin-top:8px;">
        If this is blank, we need to add boxer_id into settings.
      </div>
    </div>

    <div class="card">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:18px;">
        <div>
          <label class="small"><strong>First name</strong></label>
          <input id="firstName" type="text"
            style="width:100%; padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
        </div>

        <div>
          <label class="small"><strong>Last name</strong></label>
          <input id="lastName" type="text"
            style="width:100%; padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
        </div>

        <div>
          <label class="small"><strong>Date of birth (UK)</strong></label>
          <input id="dobUk" type="text" placeholder="dd/mm/yyyy"
            style="width:100%; padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
          <div class="small" style="margin-top:6px;">Example: 24/02/2011</div>
        </div>

        <div>
          <label class="small"><strong>Club</strong></label>
          <input id="club" type="text"
            style="width:100%; padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
        </div>

        <div>
          <label class="small"><strong>Stance</strong></label>
          <select id="stance"
            style="width:100%; padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
            <option value="">—</option>
            <option value="orthodox">Orthodox</option>
            <option value="southpaw">Southpaw</option>
          </select>
        </div>

        <div>
          <label class="small"><strong>Injury notes</strong></label>
          <input id="notes" type="text" placeholder="optional"
            style="width:100%; padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
        </div>
      </div>

      <div style="margin-top:18px;">
        <button class="btn" id="saveBtn" type="button">Save profile to DB</button>
        <span class="small" id="savedMsg" style="margin-left:10px;"></span>
      </div>

      <div class="small" style="margin-top:10px;">
        Tip: Open DevTools → Network → Fetch/XHR, then press Save. You will see the POST and the JSON payload.
      </div>
    </div>

    <div class="footer">boxXcel — Training and information only</div>
  </div>
</div>

<script src="/assets/app.js"></script>
<script>
  renderTopbar("boxXcel — Profile");
  renderNav();

  const SETTINGS_KEY = "boxxcel_settings_v1";
  const API_BASE = "https://0v4tvwe5l4.execute-api.eu-west-2.amazonaws.com/prod";

  function loadSettings(){
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveSettings(s){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
  }

  function getAuthToken(){
    // Prefer access_token for API Gateway JWT authorizer; fallback to id_token.
    return localStorage.getItem("access_token") || localStorage.getItem("id_token") || "";
  }

  function authHeadersJson(){
    const t = getAuthToken();
    return {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + t
    };
  }

  function parseUkDobToIso(uk){
    const s = String(uk || "").trim();
    if(!s) return null;
    const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
    if(!m) throw new Error("DOB must be dd/mm/yyyy");
    const dd = m[1], mm = m[2], yyyy = m[3];
    return `${yyyy}-${mm}-${dd}`;
  }

  function isoToUk(iso){
    const s = String(iso || "").trim();
    if(!s) return "";
    const m = s.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if(!m) return "";
    return `${m[3]}/${m[2]}/${m[1]}`;
  }

  function getBoxerId(){
    const settings = loadSettings();
    const fromSettings = (settings.boxer_id || settings.boxerId || "").trim();
    const fromInput = (document.getElementById("boxerId").value || "").trim();
    return fromInput || fromSettings;
  }

  async function apiGetProfile(boxer_id){
    const url = `${API_BASE}/api/boxer/profile?boxer_id=${encodeURIComponent(boxer_id)}`;
    const r = await fetch(url, { headers: authHeadersJson(), cache:"no-store" });
    const t = await r.text();
    let j; try { j = JSON.parse(t); } catch { j = { raw:t }; }
    if(!r.ok) throw new Error(j.error || j.message || ("GET failed: " + r.status));
    return j;
  }

  async function apiSaveProfile(payload){
    const url = `${API_BASE}/api/boxer/profile`;
    const r = await fetch(url, {
      method:"POST",
      headers: authHeadersJson(),
      body: JSON.stringify(payload)
    });
    const t = await r.text();
    let j; try { j = JSON.parse(t); } catch { j = { raw:t }; }
    if(!r.ok) throw new Error(j.error || j.message || ("POST failed: " + r.status));
    return j;
  }

  async function boot(){
    // Fill boxer_id from settings if present
    const settings = loadSettings();
    const boxer_id = (settings.boxer_id || settings.boxerId || "").trim();
    if(boxer_id) document.getElementById("boxerId").value = boxer_id;

    // Try load profile only if we have boxer_id
    if(!boxer_id){
      document.getElementById("statusLine").textContent =
        "Loaded ✓ (no saved profile yet — boxer_id missing in settings)";
      return;
    }

    try{
      const res = await apiGetProfile(boxer_id);
      const p = (res && res.profile) ? res.profile : null;

      if(!p){
        document.getElementById("statusLine").textContent = "Loaded ✓ (no saved profile yet)";
        return;
      }

      document.getElementById("statusLine").textContent = "Loaded ✓ (profile found)";
      document.getElementById("firstName").value = p.first_name || "";
      document.getElementById("lastName").value  = p.last_name || "";
      document.getElementById("dobUk").value     = isoToUk(p.dob);
      document.getElementById("club").value      = p.club || "";
      document.getElementById("stance").value    = p.stance || "";
      document.getElementById("notes").value     = p.notes || "";

    }catch(e){
      console.error("GET profile failed:", e);
      document.getElementById("statusLine").textContent =
        "Loaded ✓ (no saved profile yet, or GET failed — check console)";
    }
  }

  document.getElementById("copyBoxerId").onclick = async () => {
    const v = document.getElementById("boxerId").value || "";
    if(!v) return;
    try{
      await navigator.clipboard.writeText(v);
    }catch{}
  };

  document.getElementById("saveBtn").onclick = async () => {
    const boxer_id = getBoxerId();
    if(!boxer_id){
      alert("Save failed: Missing boxer_id");
      return;
    }

    // Persist boxer_id into settings so Training page can use it too
    const s = loadSettings();
    s.boxer_id = boxer_id;
    saveSettings(s);

    let dobIso = null;
    try{
      dobIso = parseUkDobToIso(document.getElementById("dobUk").value);
    }catch(e){
      alert("Save failed: " + e.message);
      return;
    }

    const payload = {
      boxer_id,
      first_name: (document.getElementById("firstName").value || "").trim(),
      last_name:  (document.getElementById("lastName").value || "").trim(),
      dob: dobIso ? dobIso : null,              // send ISO to API/DB
      club: (document.getElementById("club").value || "").trim(),
      stance: (document.getElementById("stance").value || "").trim(),
      notes: (document.getElementById("notes").value || "").trim() || null
    };

    const msg = document.getElementById("savedMsg");
    msg.textContent = "Saving...";
    document.getElementById("saveBtn").disabled = true;

    try{
      await apiSaveProfile(payload);
      msg.textContent = "Saved ✓";
      setTimeout(()=> msg.textContent="", 1500);
    }catch(e){
      console.error("POST profile failed:", e);
      alert("Save failed: " + (e.message || "Unknown error"));
      msg.textContent = "";
    }finally{
      document.getElementById("saveBtn").disabled = false;
    }
  };

  boot();
</script>

</body>
</html>
