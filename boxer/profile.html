<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>boxXcel — Profile</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>
<body>
<script src="/auth/guard.js"></script>
<script src="/assets/config.js"></script>

<div class="shell">
  <div class="topbar" data-topbar></div>

  <div class="container">
    <div data-nav></div>

    <div class="card">
      <h2>Boxer Profile</h2>
      <div class="small" id="statusLine">Loading…</div>
      <div class="small">This page saves to the database.</div>
    </div>

    <div class="card">
      <strong>Your boxer_id</strong>
      <div class="small">Tip: this must match the boxer linked to your login.</div>

      <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <input id="boxerId" type="text" style="flex:1; min-width:280px; padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
        <button class="btn secondary" id="copyBoxerId" type="button">Copy</button>
        <button class="btn" id="saveBoxerId" type="button">Save boxer_id</button>
      </div>
      <div class="small" id="boxerIdSaved" style="margin-top:8px;"></div>
    </div>

    <div class="card">
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:16px;">
        <div>
          <label class="small"><strong>First name</strong></label><br/>
          <input id="firstName" type="text" style="width:100%; padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
        </div>

        <div>
          <label class="small"><strong>Last name</strong></label><br/>
          <input id="lastName" type="text" style="width:100%; padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
        </div>

        <div>
          <label class="small"><strong>Date of birth (DD/MM/YYYY)</strong></label><br/>
          <input id="dob" type="text" placeholder="e.g. 14/06/2005" style="width:100%; padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
          <div class="small">UK format. We will convert and store correctly.</div>
        </div>

        <div>
          <label class="small"><strong>Club</strong></label><br/>
          <input id="club" type="text" style="width:100%; padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
        </div>

        <div>
          <label class="small"><strong>Stance</strong></label><br/>
          <select id="stance" style="width:100%; padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
            <option value="">—</option>
            <option value="orthodox">Orthodox</option>
            <option value="southpaw">Southpaw</option>
          </select>
        </div>

        <div>
          <label class="small"><strong>Injury notes</strong></label><br/>
          <input id="notes" type="text" placeholder="optional" style="width:100%; padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
        </div>
      </div>

      <div style="margin-top:16px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <button class="btn" id="saveProfile" type="button">Save profile to DB</button>
        <span class="small" id="saveResult"></span>
      </div>

      <div class="small" style="margin-top:10px;">
        Tip: DevTools → Network → Fetch/XHR, then press Save. You will see the POST and JSON payload.
      </div>
    </div>

    <div class="footer">boxXcel — Training support only</div>
  </div>
</div>

<script src="/assets/app.js"></script>
<script>
  renderTopbar("boxXcel — Profile");
  renderNav();

  const SETTINGS_KEY = "boxxcel_settings_v1";
  let API_BASE = "";

  // Load API_BASE from config
  (async function initConfig() {
    try {
      const config = await CONFIG.load();
      API_BASE = config.apiBase;
    } catch (e) {
      console.error("Failed to load config:", e);
      API_BASE = "https://0v4tvwe5l4.execute-api.eu-west-2.amazonaws.com/prod";
    }
  })();

  function loadSettings(){
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveSettings(s){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
  }

  function getToken(){
    // Your other pages used id_token for Authorization
    return localStorage.getItem("id_token") || "";
  }

  function authHeadersJson(){
    return {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + getToken(),
    };
  }

  function getBoxerId(){
    const s = loadSettings();
    return (s.boxer_id || s.boxerId || "").trim();
  }

  function setBoxerId(id){
    const s = loadSettings();
    s.boxer_id = id.trim();
    saveSettings(s);
  }

  async function apiGetProfile(boxer_id){
    const url = `${API_BASE}/api/boxer/profile?boxer_id=${encodeURIComponent(boxer_id)}`;
    const r = await fetch(url, { headers: authHeadersJson(), cache: "no-store" });
    const t = await r.text();
    if(!r.ok) throw new Error(t || ("HTTP " + r.status));
    return JSON.parse(t);
  }

  async function apiSaveProfile(payload){
    const url = `${API_BASE}/api/boxer/profile`;
    const r = await fetch(url, { method:"POST", headers: authHeadersJson(), body: JSON.stringify(payload) });
    const t = await r.text();
    if(!r.ok) throw new Error(t || ("HTTP " + r.status));
    return JSON.parse(t);
  }

  function fillForm(p){
    document.getElementById("firstName").value = p?.first_name || "";
    document.getElementById("lastName").value  = p?.last_name || "";
    document.getElementById("club").value      = p?.club || "";
    document.getElementById("stance").value    = p?.stance || "";
    document.getElementById("notes").value     = p?.notes || "";

    // dob comes back like "2011-06-14" from DB, show as DD/MM/YYYY for UK
    if (p?.dob) {
      const s = String(p.dob).slice(0,10);
      const parts = s.split("-");
      if (parts.length === 3) {
        document.getElementById("dob").value = `${parts[2]}/${parts[1]}/${parts[0]}`;
      } else {
        document.getElementById("dob").value = "";
      }
    } else {
      document.getElementById("dob").value = "";
    }
  }

  async function boot(){
    const boxer_id = getBoxerId();
    document.getElementById("boxerId").value = boxer_id;

    if(!boxer_id){
      document.getElementById("statusLine").textContent = "Please save your boxer_id first.";
      return;
    }

    try{
      const res = await apiGetProfile(boxer_id);
      document.getElementById("statusLine").textContent = "Loaded ✓";
      fillForm(res.profile || null);
    }catch(e){
      console.warn(e);
      document.getElementById("statusLine").textContent = "Loaded ✓ (no saved profile yet, or GET failed — check console)";
    }
  }

  document.getElementById("copyBoxerId").onclick = async () => {
    const v = document.getElementById("boxerId").value.trim();
    if(!v) return;
    await navigator.clipboard.writeText(v);
  };

  document.getElementById("saveBoxerId").onclick = async () => {
    const v = document.getElementById("boxerId").value.trim();
    if(!v){
      alert("Please paste a boxer_id first.");
      return;
    }
    setBoxerId(v);
    document.getElementById("boxerIdSaved").textContent = "Saved ✓";
    setTimeout(()=>document.getElementById("boxerIdSaved").textContent="", 1500);
    await boot();
  };

  document.getElementById("saveProfile").onclick = async () => {
    const boxer_id = getBoxerId();
    if(!boxer_id){
      alert("Save failed: Missing boxer_id (press 'Save boxer_id' first).");
      return;
    }

    const payload = {
      boxer_id,
      first_name: document.getElementById("firstName").value.trim(),
      last_name:  document.getElementById("lastName").value.trim(),
      dob:        document.getElementById("dob").value.trim(),   // DD/MM/YYYY accepted
      club:       document.getElementById("club").value.trim(),
      stance:     document.getElementById("stance").value,
      notes:      document.getElementById("notes").value.trim() || null,
    };

    document.getElementById("saveProfile").disabled = true;
    document.getElementById("saveResult").textContent = "Saving…";

    try{
      const res = await apiSaveProfile(payload);
      document.getElementById("saveResult").textContent = "Saved ✓";
      fillForm(res.profile || null);
    }catch(e){
      console.error(e);
      alert("Save failed: " + (e?.message || String(e)));
      document.getElementById("saveResult").textContent = "";
    }finally{
      document.getElementById("saveProfile").disabled = false;
    }
  };

  boot();
</script>
</body>
</html>
