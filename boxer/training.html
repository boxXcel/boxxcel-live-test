<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>boxXcel — Training plan</title>
  <link rel="stylesheet" href="/assets/app.css" />
</head>
<body>
<script src="/auth/guard.js"></script>

<div class="shell">
  <div class="topbar" data-topbar></div>

  <div class="container">
    <div data-nav></div>

    <div class="card">
      <h2 id="dayTitle">Training plan (Age 12–15)</h2>
      <div class="small" id="dayMeta">Loading today’s plan…</div>
    </div>

    <div id="cards"></div>

    <div class="footer">
      boxXcel — Training support application. Training and information only.
    </div>
  </div>
</div>

<script src="/assets/app.js"></script>
<script>
  renderTopbar("boxXcel — Training plan");
  renderNav();

  const SETTINGS_KEY = "boxxcel_settings_v1";
  const COMPLETIONS_KEY = "boxxcel_completions_v1";

// ===== API CONFIG =====
const API_BASE = "https://0v4tvwe5l4.execute-api.eu-west-2.amazonaws.com/prod";
const PROGRAMME = "12wk_fundamentals";
const AGE_GROUP = "12-15";

function cardsApiUrl(){
  return `${API_BASE}/api/cards?programme=${encodeURIComponent(PROGRAMME)}&age=${encodeURIComponent(AGE_GROUP)}`;
}
function planApiUrlForWeek(week){
  return `${API_BASE}/api/plan?programme=${encodeURIComponent(PROGRAMME)}&age=${encodeURIComponent(AGE_GROUP)}&week=${encodeURIComponent(week)}`;
}

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function todayISO(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off * 60000);
    return local.toISOString().slice(0,10);
  }

  function loadSettings(){
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}"); }
    catch { return {}; }
  }

  function loadCompletions(){
    try { return JSON.parse(localStorage.getItem(COMPLETIONS_KEY) || "{}"); }
    catch { return {}; }
  }

  function saveCompletions(obj){
    localStorage.setItem(COMPLETIONS_KEY, JSON.stringify(obj));
  }

  function daysBetween(startISO, endISO){
    const s = new Date(startISO + "T00:00:00");
    const e = new Date(endISO + "T00:00:00");
    return Math.floor((e - s) / (24*60*60*1000));
  }

  function getProgrammeDayNumber(){
    const s = loadSettings();
    if (!s.startDate) return 1;
    return Math.max(1, daysBetween(s.startDate, todayISO()) + 1);
  }

  function getWeekAndDay(dayNumber){
    return {
      week: Math.floor((dayNumber - 1) / 7) + 1,
      dayInWeek: ((dayNumber - 1) % 7) + 1
    };
  }

  function getCompletedSetFor(date){
    const all = loadCompletions();
    const d = all[date] || { cards: [] };
    return new Set(d.cards || []);
  }

  function setCardComplete(date, id, done){
    const all = loadCompletions();
    const d = all[date] || { cards: [], required: [] };
    const set = new Set(d.cards || []);
    done ? set.add(id) : set.delete(id);
    all[date] = { ...d, cards: [...set] };
    saveCompletions(all);
  }

  function setRequired(date, ids){
    const all = loadCompletions();
    const d = all[date] || { cards: [] };
    all[date] = { ...d, required: ids };
    saveCompletions(all);
  }

  function list(arr){
    return `<ul class="small">${arr.map(x=>`<li>${esc(x)}</li>`).join("")}</ul>`;
  }

  function cardHtml(c, done){
    return `
      <div class="card">
        <h2>${esc(c.title)}</h2>
        <div class="small"><strong>Goal:</strong> ${esc(c.goal)}</div>
        <div class="small"><strong>Time:</strong> ${esc(c.duration)}</div>
        <div class="small"><strong>Equipment:</strong> ${esc(c.equipment)}</div>

        <div class="small"><strong>Steps</strong></div>
        ${list(c.steps)}

        <div class="small"><strong>Safety</strong></div>
        ${list(c.safety)}

        <button class="btn ${done ? "" : "secondary"}"
          data-id="${esc(c.id)}">
          ${done ? "Completed ✓" : "Mark complete"}
        </button>
      </div>
    `;
  }

  async function load(){
    const date = todayISO();
    const dayNum = getProgrammeDayNumber();
    const { week, dayInWeek } = getWeekAndDay(dayNum);

const [cardsRes, planRes] = await Promise.all([
  if (!cardsRes.ok){
  const t = await cardsRes.text().catch(()=> "");
  throw new Error(`Cards API failed (${cardsRes.status}): ${t}`);
}
if (!planRes.ok){
  const t = await planRes.text().catch(()=> "");
  throw new Error(`Plan API failed (${planRes.status}): ${t}`);
}

    const cards = await cardsRes.json();
    const plan = await planRes.json();
    const dayPlan = plan.days.find(d => d.day === dayInWeek);

    document.getElementById("dayTitle").textContent =
      `Week ${week} — Day ${dayInWeek}: ${dayPlan.name}`;

    const settings = loadSettings();
    const freq = settings.frequency === 6 ? 6 : 5;

    if (dayPlan.type === "rest"){
      document.getElementById("dayMeta").textContent = "Rest day";
      setRequired(date, []);
      document.getElementById("cards").innerHTML =
        `<div class="card"><div class="small">Recovery day. No training required.</div></div>`;
      return;
    }

    const required =
      (dayInWeek === 6 && dayPlan.type === "optional" && freq === 5)
        ? []
        : dayPlan.card_ids;

    setRequired(date, required);

    document.getElementById("dayMeta").textContent =
      required.length
        ? "Complete all cards to finish today"
        : "Optional recovery day";

    const map = Object.fromEntries(cards.map(c=>[c.id,c]));
    const done = getCompletedSetFor(date);

    document.getElementById("cards").innerHTML =
      dayPlan.card_ids.map(id =>
        cardHtml(map[id], done.has(id))
      ).join("");

    document.querySelectorAll("[data-id]").forEach(b=>{
      b.onclick = ()=>{
        const id = b.dataset.id;
        const nowDone = !b.textContent.includes("Completed");
        setCardComplete(date, id, nowDone);
        load();
      };
    });
  }

  load().catch(err => {
  console.error(err);

  const meta = document.getElementById("dayMeta");
  if (meta) meta.textContent = "Error loading training plan.";

  const cards = document.getElementById("cards");
  if (cards) {
    cards.innerHTML = `
      <div class="card">
        <div class="small">Unable to load training data. Please refresh.</div>
      </div>
    `;
  }
});
</script>
</body>
</html>
