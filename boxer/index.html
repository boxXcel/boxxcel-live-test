<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>boxXcel — Dashboard</title>
  <link rel="stylesheet" href="/assets/app.css">
</head>
<body>
<script src="/auth/guard.js"></script>

<div class="shell">
  <div class="topbar" data-topbar></div>

  <div class="container">
    <div data-nav></div>

    <!-- Training frequency -->
    <div class="card">
      <strong>Training frequency</strong>
      <div class="small">
        Default is 5 days/week. Switch to 6 only if the boxer already trains regularly.
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <select id="freq"
          style="padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
          <option value="5">Standard — 5 training days/week</option>
          <option value="6">Advanced — 6 training days/week</option>
        </select>

        <button class="btn" id="saveFreq" type="button">Save</button>
        <span class="small" id="freqSaved"></span>
      </div>
    </div>

    <!-- Programme start date -->
    <div class="card">
      <strong>Programme start date</strong>
      <div class="small">
        Used to automatically select the correct training day.
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <input
          id="startDate"
          type="date"
          style="padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;"
        >
        <button class="btn" id="saveStart" type="button">Save</button>
        <span class="small" id="startSaved"></span>
      </div>
    </div>

    <!-- Status tiles -->
    <div class="tile-grid">
      <div class="tile">
        <strong>Today’s Session</strong>
        <div class="small" id="todayStatus">—</div>
      </div>

      <div class="tile">
        <strong>Weekly Completion</strong>
        <div class="small" id="weeklyStatus">—</div>
      </div>

      <div class="tile">
        <strong>Latest Weight</strong>
        <div class="small">See Weight page</div>
      </div>
    </div>

    <!-- Today’s Focus -->
    <div class="card">
      <strong>Today’s Focus</strong>
      <div class="small" id="todayFocusMeta">Loading…</div>
      <div id="todayFocusList" style="margin-top:10px;"></div>
    </div>

    <!-- This Week strip -->
    <div class="card">
      <strong>This Week</strong>
      <div class="small" id="weekStripMeta">Loading…</div>
      <div id="weekStrip"
           style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;"></div>
    </div>

    <!-- Safety -->
    <div class="card">
      <strong>Safety Reminder</strong>
      <div class="small">
        Training and information only. Stop if unwell, dizzy, or in pain.
        Under-18s should train with appropriate supervision.
      </div>
    </div>

    <div class="footer">boxXcel — Training support only</div>
  </div>
</div>

<script src="/assets/app.js"></script>
<script>
  renderTopbar("boxXcel — Boxer");
  renderNav();

  const SETTINGS_KEY = "boxxcel_settings_v1";
  const COMPLETIONS_KEY = "boxxcel_completions_v1";

  const CARDS_URL = "/boxer/data/training_cards_12_15.json";

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function todayISO(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off * 60000);
    return local.toISOString().slice(0,10);
  }

  function loadSettings(){
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}"); }
    catch { return {}; }
  }

  function saveSettings(s){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
  }

  function loadCompletions(){
    try { return JSON.parse(localStorage.getItem(COMPLETIONS_KEY) || "{}"); }
    catch { return {}; }
  }

  function saveCompletions(obj){
    localStorage.setItem(COMPLETIONS_KEY, JSON.stringify(obj));
  }

  function daysBetween(startISO, endISO){
    const s = new Date(startISO + "T00:00:00");
    const e = new Date(endISO + "T00:00:00");
    return Math.floor((e - s) / (24*60*60*1000));
  }

  function getProgrammeDayNumber(){
    const s = loadSettings();
    if (!s.startDate) return 1;
    return Math.max(1, daysBetween(s.startDate, todayISO()) + 1);
  }

  function getWeekAndDay(dayNumber){
    return {
      week: Math.floor((dayNumber - 1) / 7) + 1,
      dayInWeek: ((dayNumber - 1) % 7) + 1
    };
  }

  function getPlanUrlForWeek(week){
    if (week === 2) return "/boxer/data/plan_12_15_week2.json";
    return "/boxer/data/plan_12_15_week1.json";
  }

  // Day is complete ONLY if all required card IDs are completed
  function isDayComplete(date){
    const all = loadCompletions();
    const d = all[date];
    if (!d) return false;

    const required = Array.isArray(d.required) ? d.required : [];
    const done = Array.isArray(d.cards) ? d.cards : [];

    if (required.length === 0) return false; // rest/optional days don’t count
    return required.every(id => done.includes(id));
  }

  function datesLast7(){
    const out = [];
    const now = new Date();
    for(let i=0;i<7;i++){
      const d = new Date(now);
      d.setDate(now.getDate() - i);
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off * 60000);
      out.push(local.toISOString().slice(0,10));
    }
    return out;
  }

  // Ensure today's "required" cards are set even if user doesn't open Training
  async function ensureTodayRequiredIsSet(){
    const settings = loadSettings();
    const freq = settings.frequency === 6 ? 6 : 5;

    const programmeDay = getProgrammeDayNumber();
    const { week, dayInWeek } = getWeekAndDay(programmeDay);
    const planUrl = getPlanUrlForWeek(week);

    const res = await fetch(planUrl, { cache: "no-store" });
    if (!res.ok) return;

    const plan = await res.json();
    const dayPlan = (plan.days || []).find(d => d.day === dayInWeek);
    if (!dayPlan) return;

    const date = todayISO();

    const required =
      (dayInWeek === 6 && dayPlan.type === "optional" && freq === 5)
        ? []
        : (dayPlan.card_ids || []);

    const all = loadCompletions();
    const existing = all[date] || { cards: [] };
    all[date] = { ...existing, required };
    saveCompletions(all);
  }

  function renderFocusList(items){
    const holder = document.getElementById("todayFocusList");
    if (!items || items.length === 0){
      holder.innerHTML = "";
      return;
    }
    holder.innerHTML = `
      <ul class="small" style="margin:0; padding-left: 18px;">
        ${items.map(t => `<li>${esc(t)}</li>`).join("")}
      </ul>
    `;
  }

  async function renderTodayFocus(){
    const meta = document.getElementById("todayFocusMeta");
    const settings = loadSettings();
    const freq = settings.frequency === 6 ? 6 : 5;

    const programmeDay = getProgrammeDayNumber();
    const { week, dayInWeek } = getWeekAndDay(programmeDay);
    const planUrl = getPlanUrlForWeek(week);

    const [planRes, cardsRes] = await Promise.all([
      fetch(planUrl, { cache: "no-store" }),
      fetch(CARDS_URL, { cache: "no-store" })
    ]);

    if (!planRes.ok || !cardsRes.ok){
      meta.textContent = "Could not load today’s focus (missing data files).";
      renderFocusList([]);
      return;
    }

    const plan = await planRes.json();
    const cards = await cardsRes.json();

    const dayPlan = (plan.days || []).find(d => d.day === dayInWeek);
    if (!dayPlan){
      meta.textContent = "No plan found for today.";
      renderFocusList([]);
      return;
    }

    meta.textContent = `Week ${week} — Day ${dayInWeek}: ${dayPlan.name}`;

    if (dayPlan.type === "rest"){
      renderFocusList(["Rest day — recovery only (sleep, hydration, light movement)."]);
      return;
    }

    if (dayInWeek === 6 && dayPlan.type === "optional" && freq === 5){
      renderFocusList([
        "Active recovery day (5 days/week).",
        "If the boxer trains regularly, switch to 6 days/week."
      ]);
      return;
    }

    const map = new Map((cards || []).map(c => [c.id, c]));
    const titles = (dayPlan.card_ids || [])
      .map(id => map.get(id))
      .filter(Boolean)
      .map(c => c.title);

    if (titles.length === 0){
      renderFocusList(["No cards available for today (check card IDs)."]);
      return;
    }

    renderFocusList(titles);
  }

  function startOfProgrammeWeek(startDateISO, weekNumber){
    const start = new Date(startDateISO + "T00:00:00");
    const d = new Date(start);
    d.setDate(start.getDate() + (weekNumber - 1) * 7);
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off * 60000);
    return local.toISOString().slice(0,10);
  }

  function addDays(iso, days){
    const d = new Date(iso + "T00:00:00");
    d.setDate(d.getDate() + days);
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off * 60000);
    return local.toISOString().slice(0,10);
  }

  function renderWeekStripDay(label, state, isToday){
    const base =
      "display:inline-flex; align-items:center; justify-content:center;" +
      "min-width:44px; height:44px; border-radius:14px; padding:0 10px;" +
      "border:1px solid rgba(203,213,225,.18);" +
      "background:rgba(2,6,23,.15);" +
      "font-weight:700;";

    let symbol = "⭕";
    let title = "Pending";
    if (state === "done"){ symbol = "✅"; title = "Completed"; }
    if (state === "rest"){ symbol = "—"; title = "Rest day"; }
    if (state === "optional"){ symbol = "◻"; title = "Optional (5 days/week)"; }

    const ring = isToday ? " box-shadow:0 0 0 2px rgba(0,123,255,.65) inset;" : "";
    return `<div title="${title}" style="${base}${ring}">${symbol} ${label}</div>`;
  }

  async function renderWeekStrip(){
    const meta = document.getElementById("weekStripMeta");
    const holder = document.getElementById("weekStrip");

    const settings = loadSettings();
    const freq = settings.frequency === 6 ? 6 : 5;

    const programmeDay = getProgrammeDayNumber();
    const { week, dayInWeek } = getWeekAndDay(programmeDay);
    const planUrl = getPlanUrlForWeek(week);

    if (!settings.startDate){
      meta.textContent = "Set a programme start date to track your week.";
      holder.innerHTML = ["D1","D2","D3","D4","D5","D6","D7"]
        .map(d => renderWeekStripDay(d, "pending", false))
        .join("");
      return;
    }

    const planRes = await fetch(planUrl, { cache:"no-store" });
    if (!planRes.ok){
      meta.textContent = "Could not load weekly plan.";
      holder.innerHTML = "";
      return;
    }

    const plan = await planRes.json();
    const days = Array.isArray(plan.days) ? plan.days : [];

    const weekStartISO = startOfProgrammeWeek(settings.startDate, week);
    const today = todayISO();

    meta.textContent = `Week ${week} overview (today highlighted)`;

    const pieces = [];

    for (let d = 1; d <= 7; d++){
      const dayPlan = days.find(x => x.day === d) || { type:"training", card_ids:[] };
      const dateISO = addDays(weekStartISO, d - 1);

      let state = "pending";

      if (dayPlan.type === "rest"){
        state = "rest";
      } else if (d === 6 && dayPlan.type === "optional" && freq === 5){
        state = "optional";
      } else {
        const required =
          (d === 6 && dayPlan.type === "optional" && freq === 5)
            ? []
            : (dayPlan.card_ids || []);

        const all = loadCompletions();
        const existing = all[dateISO] || { cards: [] };
        all[dateISO] = { ...existing, required };
        saveCompletions(all);

        state = isDayComplete(dateISO) ? "done" : "pending";
      }

      pieces.push(renderWeekStripDay(`D${d}`, state, dateISO === today));
    }

    holder.innerHTML = pieces.join("");
  }

  async function renderStats(){
    const s = loadSettings();

    const freq = s.frequency === 6 ? 6 : 5;
    document.getElementById("freq").value = String(freq);

    if (s.startDate){
      document.getElementById("startDate").value = s.startDate;
    }

    await ensureTodayRequiredIsSet();

    const today = todayISO();
    document.getElementById("todayStatus").textContent =
      isDayComplete(today) ? "Completed ✓" : "Not completed";

    const last7 = datesLast7();
    const completedDays = last7.filter(isDayComplete).length;
    const pct = Math.round((completedDays / freq) * 100);

    document.getElementById("weeklyStatus").textContent =
      `${completedDays}/${freq} days (${isFinite(pct) ? pct : 0}%)`;

    await renderTodayFocus();
    await renderWeekStrip();
  }

  document.getElementById("saveFreq").onclick = async () => {
    const s = loadSettings();
    s.frequency = Number(document.getElementById("freq").value) === 6 ? 6 : 5;
    saveSettings(s);
    document.getElementById("freqSaved").textContent = "Saved ✓";
    setTimeout(() => document.getElementById("freqSaved").textContent = "", 1500);
    await renderStats();
  };

  document.getElementById("saveStart").onclick = async () => {
    const val = document.getElementById("startDate").value;
    if (!val) return;
    const s = loadSettings();
    s.startDate = val;
    saveSettings(s);
    document.getElementById("startSaved").textContent = "Saved ✓";
    setTimeout(() => document.getElementById("startSaved").textContent = "", 1500);
    await renderStats();
  };

  renderStats();
</script>
</body>
</html>
