<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>boxXcel — Dashboard</title>
  <link rel="stylesheet" href="/assets/app.css">
</head>
<body>
<script src="/auth/guard.js"></script>

<div class="shell">
  <div class="topbar" data-topbar></div>

  <div class="container">
    <div data-nav></div>

    <!-- Training frequency -->
    <div class="card">
      <strong>Training frequency</strong>
      <div class="small">
        Default is 5 days/week. Switch to 6 only if the boxer already trains regularly.
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <select id="freq"
          style="padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
          <option value="5">Standard — 5 training days/week</option>
          <option value="6">Advanced — 6 training days/week</option>
        </select>

        <button class="btn" id="saveFreq" type="button">Save</button>
        <span class="small" id="freqSaved"></span>
      </div>
    </div>

    <!-- Programme start date -->
    <div class="card">
      <strong>Programme start date</strong>
      <div class="small">
        Used to automatically select the correct training day.
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <input
          id="startDate"
          type="date"
          style="padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;"
        >
        <button class="btn" id="saveStart" type="button">Save</button>
        <span class="small" id="startSaved"></span>
      </div>
    </div>

    <!-- Status tiles -->
    <div class="tile-grid">
      <div class="tile">
        <strong>Today’s Session</strong>
        <div class="small" id="todayStatus">—</div>
      </div>

      <div class="tile">
        <strong>Weekly Completion</strong>
        <div class="small" id="weeklyStatus">—</div>
      </div>

      <div class="tile">
        <strong>Latest Weight</strong>
        <div class="small">See Weight page</div>
      </div>
    </div>

    <!-- Safety -->
    <div class="card">
      <strong>Safety Reminder</strong>
      <div class="small">
        Training and information only. Stop if unwell, dizzy, or in pain.
        Under-18s should train with appropriate supervision.
      </div>
    </div>

    <div class="footer">boxXcel — Training support only</div>
  </div>
</div>

<script src="/assets/app.js"></script>
<script>
  renderTopbar("boxXcel — Boxer");
  renderNav();

  const SETTINGS_KEY = "boxxcel_settings_v1";
  const COMPLETIONS_KEY = "boxxcel_completions_v1";

  function todayISO(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off * 60000);
    return local.toISOString().slice(0,10);
  }

  function loadSettings(){
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}"); }
    catch { return {}; }
  }

  function saveSettings(s){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
  }

  function loadCompletions(){
    try { return JSON.parse(localStorage.getItem(COMPLETIONS_KEY) || "{}"); }
    catch { return {}; }
  }

  /* Day is complete ONLY if all required card IDs are completed */
  function isDayComplete(date){
    const all = loadCompletions();
    const d = all[date];
    if (!d) return false;

    const required = Array.isArray(d.required) ? d.required : [];
    const done = Array.isArray(d.cards) ? d.cards : [];

    if (required.length === 0) return false; // rest/optional days don’t count
    return required.every(id => done.includes(id));
  }

  function datesLast7(){
    const out = [];
    const now = new Date();
    for(let i=0;i<7;i++){
      const d = new Date(now);
      d.setDate(now.getDate() - i);
      const off = d.getTimezoneOffset();
      const local = new Date(d.getTime() - off * 60000);
      out.push(local.toISOString().slice(0,10));
    }
    return out;
  }

  function renderStats(){
    const s = loadSettings();

    const freq = s.frequency === 6 ? 6 : 5;
    document.getElementById("freq").value = String(freq);

    if (s.startDate){
      document.getElementById("startDate").value = s.startDate;
    }

    const today = todayISO();
    document.getElementById("todayStatus").textContent =
      isDayComplete(today) ? "Completed ✓" : "Not completed";

    const last7 = datesLast7();
    const completedDays = last7.filter(isDayComplete).length;
    const pct = Math.round((completedDays / freq) * 100);

    document.getElementById("weeklyStatus").textContent =
      `${completedDays}/${freq} days (${isFinite(pct) ? pct : 0}%)`;
  }

  document.getElementById("saveFreq").onclick = () => {
    const s = loadSettings();
    s.frequency = Number(document.getElementById("freq").value) === 6 ? 6 : 5;
    saveSettings(s);
    document.getElementById("freqSaved").textContent = "Saved ✓";
    setTimeout(() => document.getElementById("freqSaved").textContent = "", 1500);
    renderStats();
  };

  document.getElementById("saveStart").onclick = () => {
    const val = document.getElementById("startDate").value;
    if (!val) return;
    const s = loadSettings();
    s.startDate = val;
    saveSettings(s);
    document.getElementById("startSaved").textContent = "Saved ✓";
    setTimeout(() => document.getElementById("startSaved").textContent = "", 1500);
    renderStats();
  };

  renderStats();
</script>
</body>
</html>
