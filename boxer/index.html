<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>boxXcel — Dashboard</title>
  <link rel="stylesheet" href="/assets/app.css">
</head>
<body>
<script src="/auth/guard.js"></script>

<div class="shell">
  <div class="topbar" data-topbar></div>

  <div class="container">
    <div data-nav></div>

    <!-- Boxer ID (kept, but /me can also resolve) -->
    <div class="card">
      <strong>Boxer ID</strong>
      <div class="small">
        This links your training completions to the correct boxer in the database.
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <input
          id="boxerId"
          type="text"
          placeholder="Paste boxer UUID here"
          style="min-width:320px;padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;"
        >
        <button class="btn" id="saveBoxerId" type="button">Save</button>
        <span class="small" id="boxerIdSaved"></span>
      </div>

      <div class="small" style="margin-top:8px; opacity:.85;" id="boxerIdHint"></div>
    </div>

    <!-- Training frequency -->
    <div class="card">
      <strong>Training frequency</strong>
      <div class="small">
        Default is 5 days/week. Switch to 6 only if the boxer already trains regularly.
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <select id="freq"
          style="padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;">
          <option value="5">Standard — 5 training days/week</option>
          <option value="6">Advanced — 6 training days/week</option>
        </select>

        <button class="btn" id="saveFreq" type="button">Save</button>
        <span class="small" id="freqSaved"></span>
      </div>
    </div>

    <!-- Programme start date -->
    <div class="card">
      <strong>Programme start date</strong>
      <div class="small">
        Used to automatically select the correct training day.
      </div>

      <div style="margin-top:10px; display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <input
          id="startDate"
          type="date"
          style="padding:10px;border-radius:10px;border:1px solid rgba(203,213,225,.18);background:rgba(2,6,23,.15);color:#e5e7eb;"
        >
        <button class="btn" id="saveStart" type="button">Save</button>
        <span class="small" id="startSaved"></span>
      </div>
    </div>

    <!-- Status tiles -->
    <div class="tile-grid">
      <div class="tile">
        <strong>Today’s Session</strong>
        <div class="small" id="todayStatus">—</div>
      </div>

      <div class="tile">
        <strong>Weekly Completion</strong>
        <div class="small" id="weeklyStatus">—</div>
      </div>

      <div class="tile">
        <strong>Latest Weight</strong>
        <div class="small">See Weight page</div>
      </div>
    </div>

    <!-- Today’s Focus -->
    <div class="card">
      <strong>Today’s Focus</strong>
      <div class="small" id="todayFocusMeta">Loading…</div>
      <div id="todayFocusList" style="margin-top:10px;"></div>
    </div>

    <!-- This Week strip -->
    <div class="card">
      <strong>This Week</strong>
      <div class="small" id="weekStripMeta">Loading…</div>
      <div id="weekStrip"
           style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; align-items:center;"></div>
    </div>

    <!-- Safety -->
    <div class="card">
      <strong>Safety Reminder</strong>
      <div class="small">
        Training and information only. Stop if unwell, dizzy, or in pain.
        Under-18s should train with appropriate supervision.
      </div>
    </div>

    <div class="footer">boxXcel — Training support only</div>
  </div>
</div>

<script src="/assets/app.js"></script>
<script>
  renderTopbar("boxXcel — Boxer");
  renderNav();

  /* =========================
     CONFIG
  ========================== */
  const SETTINGS_KEY = "boxxcel_settings_v1";

  // ✅ IMPORTANT: correct base (5l4)
  const API_BASE  = "https://0v4tvwe5l4.execute-api.eu-west-2.amazonaws.com/prod";

  // Dashboard uses static plan json (as you already do)
  const CARDS_URL = "/boxer/data/training_cards_12_15.json";
  const PROGRAMME = "12wk_fundamentals";
  const AGE_GROUP = "12-15";

  /* =========================
     HELPERS
  ========================== */
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function isoFromDateObj(d){
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off * 60000);
    return local.toISOString().slice(0,10);
  }

  function todayISO(){ return isoFromDateObj(new Date()); }

  function addDaysISO(baseISO, days){
    const d = new Date(baseISO + "T00:00:00");
    d.setDate(d.getDate() + days);
    return isoFromDateObj(d);
  }

  function loadSettings(){
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}"); }
    catch { return {}; }
  }
  function saveSettings(s){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
  }

  function getIdToken(){
    return localStorage.getItem("id_token") || localStorage.getItem("access_token") || "";
  }
  function authHeadersJson(){
    const t = getIdToken();
    return { "Content-Type":"application/json", "Authorization":"Bearer " + t };
  }

  async function apiGetJson(url){
    const res = await fetch(url, { method:"GET", headers: authHeadersJson(), cache:"no-store" });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = null; }
    if (!res.ok){
      const msg = (data && (data.error || data.message)) ? (data.error || data.message) : (text || `HTTP ${res.status}`);
      throw new Error(msg);
    }
    return data;
  }

  function daysBetween(startISO, endISO){
    const s = new Date(startISO + "T00:00:00");
    const e = new Date(endISO + "T00:00:00");
    return Math.floor((e - s) / (24*60*60*1000));
  }

  function getProgrammeDayNumber(){
    const s = loadSettings();
    if (!s.startDate) return 1;
    return Math.max(1, daysBetween(s.startDate, todayISO()) + 1);
  }

  function getWeekAndDay(dayNumber){
    return {
      week: Math.floor((dayNumber - 1) / 7) + 1,
      dayInWeek: ((dayNumber - 1) % 7) + 1
    };
  }

  function getPlanUrlForWeek(week){
    // keep your existing behaviour
    if (week === 2) return "/boxer/data/plan_12_15_week2.json";
    return "/boxer/data/plan_12_15_week1.json";
  }

  function startOfProgrammeWeek(startDateISO, weekNumber){
    const start = new Date(startDateISO + "T00:00:00");
    const d = new Date(start);
    d.setDate(start.getDate() + (weekNumber - 1) * 7);
    return isoFromDateObj(d);
  }

  /* =========================
     BOXER ID (PRODUCTION)
     - settings.boxer_id if present
     - else /me
  ========================== */
  function meApiUrl(){ return `${API_BASE}/me`; }

  async function getBoxerIdProduction(){
    const s = loadSettings();
    if (s.boxer_id) return s.boxer_id;

    if (typeof getBoxerId === "function"){
      const maybe = getBoxerId();
      if (maybe){
        s.boxer_id = maybe;
        saveSettings(s);
        return maybe;
      }
    }

    const me = await apiGetJson(meApiUrl());
    const boxer_id = me && (me.boxer_id || (me.data && me.data.boxer_id));
    if (!boxer_id) throw new Error("Could not resolve boxer_id from /me");

    s.boxer_id = boxer_id;
    saveSettings(s);
    return boxer_id;
  }

  /* =========================
     COMPLETIONS (SERVER TRUTH)
  ========================== */
  function completionsApiUrl(fromISO, toISO){
    return `${API_BASE}/api/boxer/completions?from=${encodeURIComponent(fromISO)}&to=${encodeURIComponent(toISO)}`;
  }

  function buildDoneMapFromServerPayload(payload){
    const doneByDate = new Map();

    if (payload && Array.isArray(payload.completions)){
      for (const row of payload.completions){
        if (!row) continue;
        const date = row.log_date;
        if (!doneByDate.has(date)) doneByDate.set(date, new Set());
        if (row.is_done) doneByDate.get(date).add(row.card_id);
        else doneByDate.get(date).delete(row.card_id);
      }
    }

    if (payload && payload.by_date){
      for (const [date, arr] of Object.entries(payload.by_date)){
        const set = new Set();
        (arr || []).forEach(x => { if (x && x.is_done) set.add(x.card_id); });
        doneByDate.set(date, set);
      }
    }

    return doneByDate;
  }

  async function fetchCompletionsWindow(fromISO, toISO){
    await getBoxerIdProduction(); // ensure boxer_id exists in settings
    const data = await apiGetJson(completionsApiUrl(fromISO, toISO));
    if (!data || data.ok !== true) throw new Error("Completions API returned unexpected response");
    return data;
  }

  /* =========================
     UI RENDERERS
  ========================== */
  function renderFocusList(items){
    const holder = document.getElementById("todayFocusList");
    if (!items || items.length === 0){
      holder.innerHTML = "";
      return;
    }
    holder.innerHTML = `
      <ul class="small" style="margin:0; padding-left: 18px;">
        ${items.map(t => `<li>${esc(t)}</li>`).join("")}
      </ul>
    `;
  }

  async function renderTodayFocus(){
    const meta = document.getElementById("todayFocusMeta");
    const settings = loadSettings();
    const freq = settings.frequency === 6 ? 6 : 5;

    const programmeDay = getProgrammeDayNumber();
    const { week, dayInWeek } = getWeekAndDay(programmeDay);
    const planUrl = getPlanUrlForWeek(week);

    const [planRes, cardsRes] = await Promise.all([
      fetch(planUrl, { cache: "no-store" }),
      fetch(CARDS_URL, { cache: "no-store" })
    ]);

    if (!planRes.ok || !cardsRes.ok){
      meta.textContent = "Could not load today’s focus (missing data files).";
      renderFocusList([]);
      return;
    }

    const plan = await planRes.json();
    const cards = await cardsRes.json();

    const dayPlan = (plan.days || []).find(d => d.day === dayInWeek);
    if (!dayPlan){
      meta.textContent = "No plan found for today.";
      renderFocusList([]);
      return;
    }

    meta.textContent = `Week ${week} — Day ${dayInWeek}: ${dayPlan.name}`;

    if (dayPlan.type === "rest"){
      renderFocusList(["Rest day — recovery only (sleep, hydration, light movement)."]);
      return;
    }

    if (dayInWeek === 6 && dayPlan.type === "optional" && freq === 5){
      renderFocusList([
        "Active recovery day (5 days/week).",
        "If the boxer trains regularly, switch to 6 days/week."
      ]);
      return;
    }

    const map = new Map((cards || []).map(c => [c.id, c]));
    const titles = (dayPlan.card_ids || [])
      .map(id => map.get(id))
      .filter(Boolean)
      .map(c => c.title);

    if (titles.length === 0){
      renderFocusList(["No cards available for today (check card IDs)."]);
      return;
    }

    renderFocusList(titles);
  }

  function renderWeekStripDay(label, state, isToday){
    const base =
      "display:inline-flex; align-items:center; justify-content:center;" +
      "min-width:44px; height:44px; border-radius:14px; padding:0 10px;" +
      "border:1px solid rgba(203,213,225,.18);" +
      "background:rgba(2,6,23,.15);" +
      "font-weight:700;";

    let symbol = "⭕";
    let title = "Pending";
    if (state === "done"){ symbol = "✅"; title = "Completed"; }
    if (state === "rest"){ symbol = "—"; title = "Rest day"; }
    if (state === "optional"){ symbol = "◻"; title = "Optional (5 days/week)"; }

    const ring = isToday ? " box-shadow:0 0 0 2px rgba(0,123,255,.65) inset;" : "";
    return `<div title="${title}" style="${base}${ring}">${symbol} ${label}</div>`;
  }

  function isDayCompleteFromServer(requiredIds, doneSet){
    if (!requiredIds || requiredIds.length === 0) return false;
    for (const id of requiredIds){
      if (!doneSet.has(id)) return false;
    }
    return true;
  }

  async function renderWeekStripAndStats(doneMap){
    const meta = document.getElementById("weekStripMeta");
    const holder = document.getElementById("weekStrip");

    const settings = loadSettings();
    const freq = settings.frequency === 6 ? 6 : 5;

    const programmeDay = getProgrammeDayNumber();
    const { week, dayInWeek } = getWeekAndDay(programmeDay);
    const planUrl = getPlanUrlForWeek(week);

    if (!settings.startDate){
      meta.textContent = "Set a programme start date to track your week.";
      holder.innerHTML = ["D1","D2","D3","D4","D5","D6","D7"]
        .map(d => renderWeekStripDay(d, "pending", false))
        .join("");
      document.getElementById("todayStatus").textContent = "—";
      document.getElementById("weeklyStatus").textContent = "—";
      return;
    }

    const planRes = await fetch(planUrl, { cache:"no-store" });
    if (!planRes.ok){
      meta.textContent = "Could not load weekly plan.";
      holder.innerHTML = "";
      document.getElementById("todayStatus").textContent = "—";
      document.getElementById("weeklyStatus").textContent = "—";
      return;
    }

    const plan = await planRes.json();
    const days = Array.isArray(plan.days) ? plan.days : [];

    const weekStartISO = startOfProgrammeWeek(settings.startDate, week);
    const today = todayISO();
    meta.textContent = `Week ${week} overview (today highlighted)`;

    const pieces = [];
    let completedDaysCount = 0;

    // We define "required training days" as:
    // - D1..D5 always training
    // - D6 optional if freq=5, required if freq=6 and plan says optional
    // - Rest days never count
    let targetDays = freq;

    for (let d = 1; d <= 7; d++){
      const dayPlan = days.find(x => x.day === d) || { type:"training", card_ids:[] };
      const dateISO = addDaysISO(weekStartISO, d - 1);

      let state = "pending";

      if (dayPlan.type === "rest"){
        state = "rest";
      } else if (d === 6 && dayPlan.type === "optional" && freq === 5){
        state = "optional";
      } else {
        const requiredIds = Array.isArray(dayPlan.card_ids) ? dayPlan.card_ids : [];
        const doneSet = doneMap.get(dateISO) || new Set();
        const dayDone = isDayCompleteFromServer(requiredIds, doneSet);
        state = dayDone ? "done" : "pending";
        if (dayDone) completedDaysCount++;
      }

      pieces.push(renderWeekStripDay(`D${d}`, state, dateISO === today));
    }

    holder.innerHTML = pieces.join("");

    // Today status
    const todayPlan = days.find(x => x.day === dayInWeek) || { type:"training", card_ids:[] };
    if (todayPlan.type === "rest"){
      document.getElementById("todayStatus").textContent = "Rest day";
    } else if (dayInWeek === 6 && todayPlan.type === "optional" && freq === 5){
      document.getElementById("todayStatus").textContent = "Optional day";
    } else {
      const requiredIds = Array.isArray(todayPlan.card_ids) ? todayPlan.card_ids : [];
      const doneSet = doneMap.get(today) || new Set();
      document.getElementById("todayStatus").textContent =
        isDayCompleteFromServer(requiredIds, doneSet) ? "Completed ✓" : "Not completed";
    }

    // Weekly completion tile
    const pct = Math.round((completedDaysCount / targetDays) * 100);
    document.getElementById("weeklyStatus").textContent =
      `${completedDaysCount}/${targetDays} days (${isFinite(pct) ? pct : 0}%)`;
  }

  /* =========================
     MAIN RENDER
  ========================== */
  async function renderStats(){
    const s = loadSettings();

    // Autofill settings
    if (s.boxer_id && document.getElementById("boxerId")) {
      document.getElementById("boxerId").value = s.boxer_id;
    }
    const freq = s.frequency === 6 ? 6 : 5;
    document.getElementById("freq").value = String(freq);
    if (s.startDate){
      document.getElementById("startDate").value = s.startDate;
    }

    // Ensure boxer_id exists (auto-resolve via /me if possible)
    try {
      const boxer_id = await getBoxerIdProduction();
      document.getElementById("boxerIdHint").textContent = boxer_id ? "Resolved ✓ (from settings or /me)" : "";
    } catch (e) {
      document.getElementById("boxerIdHint").textContent = "Could not auto-resolve boxer_id from /me (check /me).";
    }

    // Pull DB completions for a wide window (covers week strip + today)
    const today = todayISO();
    const fromISO = addDaysISO(today, -120);
    const toISO   = addDaysISO(today,  1);

    let doneMap = new Map();
    try {
      const payload = await fetchCompletionsWindow(fromISO, toISO);
      doneMap = buildDoneMapFromServerPayload(payload);
    } catch (e) {
      console.warn("Dashboard: completions fetch failed; showing as pending.", e);
      // leave doneMap empty (shows pending rather than incorrect)
    }

    await renderTodayFocus();
    await renderWeekStripAndStats(doneMap);
  }

  /* =========================
     SAVE HANDLERS
  ========================== */
  document.getElementById("saveBoxerId").onclick = async () => {
    const val = (document.getElementById("boxerId").value || "").trim();
    if (!val) return;

    const looksUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(val);
    if (!looksUuid) {
      alert("That doesn't look like a valid boxer ID (UUID). Please paste the full ID.");
      return;
    }

    const s = loadSettings();
    s.boxer_id = val;
    saveSettings(s);

    document.getElementById("boxerIdSaved").textContent = "Saved ✓";
    setTimeout(() => document.getElementById("boxerIdSaved").textContent = "", 1500);
    await renderStats();
  };

  document.getElementById("saveFreq").onclick = async () => {
    const s = loadSettings();
    s.frequency = Number(document.getElementById("freq").value) === 6 ? 6 : 5;
    saveSettings(s);
    document.getElementById("freqSaved").textContent = "Saved ✓";
    setTimeout(() => document.getElementById("freqSaved").textContent = "", 1500);
    await renderStats();
  };

  document.getElementById("saveStart").onclick = async () => {
    const val = document.getElementById("startDate").value;
    if (!val) return;
    const s = loadSettings();
    s.startDate = val;
    saveSettings(s);
    document.getElementById("startSaved").textContent = "Saved ✓";
    setTimeout(() => document.getElementById("startSaved").textContent = "", 1500);
    await renderStats();
  };

  renderStats();
</script>
</body>
</html>
