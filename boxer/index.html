<script>
  renderTopbar("boxXcel — Boxer");
  renderNav();

  const SETTINGS_KEY = "boxxcel_settings_v1";

  // ✅ IMPORTANT: correct API base (5l4)
  const API_BASE  = "https://0v4tvwe5l4.execute-api.eu-west-2.amazonaws.com/prod";
  const PROGRAMME = "12wk_fundamentals";
  const AGE_GROUP = "12-15";

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function todayISO(){
    const d = new Date();
    const off = d.getTimezoneOffset();
    const local = new Date(d.getTime() - off * 60000);
    return local.toISOString().slice(0,10);
  }

  function isoDateFromDateObj(d){
    const x = new Date(d);
    const off = x.getTimezoneOffset();
    const local = new Date(x.getTime() - off * 60000);
    return local.toISOString().slice(0,10);
  }

  function addDaysISO(baseISO, days){
    const d = new Date(baseISO + "T00:00:00");
    d.setDate(d.getDate() + days);
    return isoDateFromDateObj(d);
  }

  function loadSettings(){
    try { return JSON.parse(localStorage.getItem(SETTINGS_KEY) || "{}"); }
    catch { return {}; }
  }

  function saveSettings(s){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
  }

  function getIdToken(){
    return localStorage.getItem("id_token") || localStorage.getItem("access_token") || "";
  }

  function authHeadersJson(){
    const t = getIdToken();
    return {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + t,
    };
  }

  async function apiGetJson(url){
    const res = await fetch(url, { method:"GET", headers: authHeadersJson(), cache:"no-store" });
    const text = await res.text();
    let data = null;
    try { data = text ? JSON.parse(text) : null; } catch { data = null; }
    if (!res.ok){
      const msg = (data && (data.error || data.message)) ? (data.error || data.message) : (text || `HTTP ${res.status}`);
      throw new Error(msg);
    }
    return data;
  }

  function cardsApiUrl(){
    return `${API_BASE}/api/cards?programme=${encodeURIComponent(PROGRAMME)}&age=${encodeURIComponent(AGE_GROUP)}`;
  }

  function planApiUrlForWeek(week){
    return `${API_BASE}/api/plan?programme=${encodeURIComponent(PROGRAMME)}&age=${encodeURIComponent(AGE_GROUP)}&week=${encodeURIComponent(week)}`;
  }

  function completionsApiUrl(fromISO, toISO){
    return `${API_BASE}/api/boxer/completions?from=${encodeURIComponent(fromISO)}&to=${encodeURIComponent(toISO)}`;
  }

  function daysBetween(startISO, endISO){
    const s = new Date(startISO + "T00:00:00");
    const e = new Date(endISO + "T00:00:00");
    return Math.floor((e - s) / 86400000);
  }

  function getProgrammeDayNumber(){
    const s = loadSettings();
    if (!s.startDate) return 1;
    return Math.max(1, daysBetween(s.startDate, todayISO()) + 1);
  }

  function getWeekAndDay(dayNumber){
    return {
      week: Math.floor((dayNumber - 1) / 7) + 1,
      dayInWeek: ((dayNumber - 1) % 7) + 1
    };
  }

  function startOfProgrammeWeek(startDateISO, weekNumber){
    const start = new Date(startDateISO + "T00:00:00");
    const d = new Date(start);
    d.setDate(start.getDate() + (weekNumber - 1) * 7);
    return isoDateFromDateObj(d);
  }

  // Build map: date -> Set(card_id) where is_done=true
  function buildDoneMap(payload){
    const map = new Map();

    // supports payload.by_date
    if (payload && payload.by_date){
      for (const [date, arr] of Object.entries(payload.by_date)){
        const set = new Set();
        (arr || []).forEach(x => { if (x && x.is_done) set.add(x.card_id); });
        map.set(date, set);
      }
      return map;
    }

    // supports payload.completions list
    if (payload && Array.isArray(payload.completions)){
      for (const row of payload.completions){
        if (!row) continue;
        const date = row.log_date;
        if (!map.has(date)) map.set(date, new Set());
        if (row.is_done) map.get(date).add(row.card_id);
        else map.get(date).delete(row.card_id);
      }
    }

    return map;
  }

  function dayRequiredCardIds(dayPlan, freq){
    if (!dayPlan) return [];
    if (dayPlan.type === "rest") return [];
    // Optional day logic (your plan seems to use "optional")
    if (dayPlan.type === "optional" && freq === 5) return [];
    return Array.isArray(dayPlan.card_ids) ? dayPlan.card_ids : [];
  }

  function isDayComplete(requiredIds, doneSet){
    if (!requiredIds || requiredIds.length === 0) return false;
    for (const id of requiredIds){
      if (!doneSet || !doneSet.has(id)) return false;
    }
    return true;
  }

  function renderFocusList(items){
    const holder = document.getElementById("todayFocusList");
    if (!items || items.length === 0){
      holder.innerHTML = "";
      return;
    }
    holder.innerHTML = `
      <ul class="small" style="margin:0; padding-left: 18px;">
        ${items.map(t => `<li>${esc(t)}</li>`).join("")}
      </ul>
    `;
  }

  function renderWeekStripDay(label, state, isToday){
    const base =
      "display:inline-flex; align-items:center; justify-content:center;" +
      "min-width:44px; height:44px; border-radius:14px; padding:0 10px;" +
      "border:1px solid rgba(203,213,225,.18);" +
      "background:rgba(2,6,23,.15);" +
      "font-weight:700;";

    let symbol = "⭕";
    let title = "Pending";
    if (state === "done"){ symbol = "✅"; title = "Completed"; }
    if (state === "rest"){ symbol = "—"; title = "Rest day"; }
    if (state === "optional"){ symbol = "◻"; title = "Optional (5 days/week)"; }

    const ring = isToday ? " box-shadow:0 0 0 2px rgba(0,123,255,.65) inset;" : "";
    return `<div title="${title}" style="${base}${ring}">${symbol} ${label}</div>`;
  }

  async function renderDashboardFromServer(){
    const s = loadSettings();
    const freq = s.frequency === 6 ? 6 : 5;

    // Fill settings UI
    if (s.boxer_id && document.getElementById("boxerId")) document.getElementById("boxerId").value = s.boxer_id;
    document.getElementById("freq").value = String(freq);
    if (s.startDate) document.getElementById("startDate").value = s.startDate;

    // Need start date to align week strip + weekly completion
    if (!s.startDate){
      document.getElementById("todayStatus").textContent = "Set programme start date";
      document.getElementById("weeklyStatus").textContent = "Set programme start date";
      document.getElementById("todayFocusMeta").textContent = "Set programme start date to load today’s focus.";
      document.getElementById("weekStripMeta").textContent = "Set a programme start date to track your week.";
      document.getElementById("weekStrip").innerHTML = ["D1","D2","D3","D4","D5","D6","D7"]
        .map(d => renderWeekStripDay(d, "pending", false))
        .join("");
      renderFocusList([]);
      return;
    }

    // Auth check
    const token = getIdToken();
    if (!token){
      document.getElementById("todayStatus").textContent = "Please login again";
      document.getElementById("weeklyStatus").textContent = "Please login again";
      document.getElementById("todayFocusMeta").textContent = "No token found — please login again.";
      document.getElementById("weekStripMeta").textContent = "No token found — please login again.";
      document.getElementById("weekStrip").innerHTML = "";
      renderFocusList([]);
      return;
    }

    const programmeDay = getProgrammeDayNumber();
    const { week, dayInWeek } = getWeekAndDay(programmeDay);

    // Fetch plan/cards for current week from API
    const [plan, cards] = await Promise.all([
      apiGetJson(planApiUrlForWeek(week)),
      apiGetJson(cardsApiUrl()),
    ]);

    const cardsMap = new Map((cards || []).map(c => [c.id, c]));

    // Week range
    const weekStartISO = startOfProgrammeWeek(s.startDate, week);
    const weekEndISO = addDaysISO(weekStartISO, 6);
    const fromISO = weekStartISO;
    const toISO = addDaysISO(weekEndISO, 1); // inclusive end -> +1 day for query

    // Fetch completions for this week from server
    const completionsPayload = await apiGetJson(completionsApiUrl(fromISO, toISO));
    const doneMap = buildDoneMap(completionsPayload);

    // Today
    const today = todayISO();
    const todayPlan = (plan.days || []).find(d => d.day === dayInWeek);
    const todayRequired = dayRequiredCardIds(todayPlan, freq);
    const todayDoneSet = doneMap.get(today) || new Set();

    document.getElementById("todayStatus").textContent =
      (todayPlan && todayPlan.type === "rest") ? "Rest day" :
      (todayRequired.length === 0) ? "Optional / not required" :
      (isDayComplete(todayRequired, todayDoneSet) ? "Completed ✓" : "Not completed");

    // Today focus
    if (!todayPlan){
      document.getElementById("todayFocusMeta").textContent = "No plan found for today.";
      renderFocusList([]);
    } else if (todayPlan.type === "rest"){
      document.getElementById("todayFocusMeta").textContent = `Week ${week} — Day ${dayInWeek}: ${todayPlan.name}`;
      renderFocusList(["Rest day — recovery only (sleep, hydration, light movement)."]);
    } else if (todayRequired.length === 0){
      document.getElementById("todayFocusMeta").textContent = `Week ${week} — Day ${dayInWeek}: ${todayPlan.name}`;
      renderFocusList([
        "Optional day (5 days/week).",
        "Switch to 6 days/week only if the boxer trains regularly."
      ]);
    } else {
      const titles = todayRequired
        .map(id => cardsMap.get(id))
        .filter(Boolean)
        .map(c => c.title);
      document.getElementById("todayFocusMeta").textContent = `Week ${week} — Day ${dayInWeek}: ${todayPlan.name}`;
      renderFocusList(titles.length ? titles : ["No cards found for today (card IDs mismatch)."]);
    }

    // Week strip + weekly completion (aligned to server)
    document.getElementById("weekStripMeta").textContent = `Week ${week} overview (today highlighted)`;

    let targetDays = 0;
    let completedDays = 0;

    const pieces = [];
    for (let d = 1; d <= 7; d++){
      const dayPlan = (plan.days || []).find(x => x.day === d) || { type:"training", card_ids:[] };
      const dateISO = addDaysISO(weekStartISO, d - 1);

      let state = "pending";

      if (dayPlan.type === "rest"){
        state = "rest";
      } else if (dayPlan.type === "optional" && freq === 5){
        state = "optional";
      } else {
        const req = dayRequiredCardIds(dayPlan, freq);
        if (req.length > 0) targetDays++;

        const doneSet = doneMap.get(dateISO) || new Set();
        const done = isDayComplete(req, doneSet);
        if (req.length > 0 && done) completedDays++;

        state = (req.length > 0 && done) ? "done" : "pending";
      }

      pieces.push(renderWeekStripDay(`D${d}`, state, dateISO === today));
    }

    document.getElementById("weekStrip").innerHTML = pieces.join("");

    const pct = targetDays ? Math.round((completedDays / targetDays) * 100) : 0;
    document.getElementById("weeklyStatus").textContent =
      `${completedDays}/${targetDays} days (${isFinite(pct) ? pct : 0}%)`;
  }

  // Save Boxer ID (keep UI behaviour, but note: server resolves boxer from token)
  document.getElementById("saveBoxerId").onclick = async () => {
    const val = (document.getElementById("boxerId").value || "").trim();
    if (!val) return;

    const looksUuid = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(val);
    if (!looksUuid) {
      alert("That doesn't look like a valid boxer ID (UUID). Please paste the full ID.");
      return;
    }

    const s = loadSettings();
    s.boxer_id = val;
    saveSettings(s);

    document.getElementById("boxerIdSaved").textContent = "Saved ✓";
    setTimeout(() => document.getElementById("boxerIdSaved").textContent = "", 1500);

    await renderDashboardFromServer();
  };

  document.getElementById("saveFreq").onclick = async () => {
    const s = loadSettings();
    s.frequency = Number(document.getElementById("freq").value) === 6 ? 6 : 5;
    saveSettings(s);
    document.getElementById("freqSaved").textContent = "Saved ✓";
    setTimeout(() => document.getElementById("freqSaved").textContent = "", 1500);
    await renderDashboardFromServer();
  };

  document.getElementById("saveStart").onclick = async () => {
    const val = document.getElementById("startDate").value;
    if (!val) return;
    const s = loadSettings();
    s.startDate = val;
    saveSettings(s);
    document.getElementById("startSaved").textContent = "Saved ✓";
    setTimeout(() => document.getElementById("startSaved").textContent = "", 1500);
    await renderDashboardFromServer();
  };

  // Boot
  renderDashboardFromServer().catch(err => {
    console.error(err);
    document.getElementById("todayStatus").textContent = "Error";
    document.getElementById("weeklyStatus").textContent = "Error";
    document.getElementById("todayFocusMeta").textContent = "Failed to load dashboard (check console).";
    document.getElementById("weekStripMeta").textContent = "Failed to load dashboard (check console).";
    document.getElementById("weekStrip").innerHTML = "";
    renderFocusList([]);
  });
</script>
